<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>MySQL on GCP - kubernetes-docker-lab</title>
<meta name="description" content="Learning how to deploy a web app from Docker to Kubernetes to GCloud">



<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="kubernetes-docker-lab">
<meta property="og:title" content="MySQL on GCP">
<meta property="og:url" content="http://localhost:4000/gcp/sql.html">













<link rel="canonical" href="http://localhost:4000/gcp/sql.html">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="kubernetes-docker-lab Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">kubernetes-docker-lab</a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Docker</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/docker/intro" class="">Introduction to docker</a></li>
          
            
            

            
            

            <li><a href="/docker/example" class="">Example of deployment with Docker</a></li>
          
            
            

            
            

            <li><a href="/k8s/swarm" class="">Docker swarm</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Kubernetes knowledges</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/k8s/architecture" class="">Architecture</a></li>
          
            
            

            
            

            <li><a href="/k8s/deployment" class="">Deployment</a></li>
          
            
            

            
            

            <li><a href="/k8s/services" class="">Service</a></li>
          
            
            

            
            

            <li><a href="/k8s/storage" class="">Volumes</a></li>
          
            
            

            
            

            <li><a href="/k8s/cron" class="">Cron task</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Deploying an app to minikube</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/k8s/minikube" class="">Minikube</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="MySQL on GCP">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">MySQL on GCP
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>In today‚Äôs article we‚Äôre going to set up a MySQL database which is going to be use by our pods‚Äôs API.</p>

<p>Do you remember how we did that with minikube ?</p>

<p>With Minikube we create a seperate StatefulSets deployment which contain a volume that was linked to our StatefulSet deployment. However as describe in previous articles, creating a database in a container is not what should be done in production environment as database need performance, storage which can grow at anytime. Thus it‚Äôs recommended to use a seperate Database environment and this is what we‚Äôre going to do today.</p>

<p>GCP has a service name Storage where we can create a relational database like MySQL or PostgreSQL</p>

<h2 id="creating-our-mysql-database-">Creating our MySQL database üíæ</h2>

<p>Let‚Äôs create our database by naming it <code class="highlighter-rouge">db</code> with the password which is <code class="highlighter-rouge">bobbaroot</code>.</p>

<blockquote>
  <p>Note: We use the same password that we gave with Minikube. However you should not do that in real production environment. This is intended for demonstration purposes.</p>
</blockquote>

<p>Now that you have create your database we will connect to the database. Run this command in your terminal, and enter your password when ask.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud sql connect db <span class="nt">--user</span><span class="o">=</span>root
</code></pre></div></div>

<p>Now we need to create a database. Run this command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create database thebestbobba<span class="p">;</span>
</code></pre></div></div>

<p>All right let‚Äôs create our table. Run these commands</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use thebestbobba<span class="p">;</span>

<span class="c"># then create the table</span>
CREATE TABLE bobba <span class="o">(</span>
    ID int NOT NULL AUTO_INCREMENT,
    name varchar<span class="o">(</span>255<span class="o">)</span>,
    price decimal,
    shop varchar<span class="o">(</span>255<span class="o">)</span>,
    flavor varchar<span class="o">(</span>255<span class="o">)</span>,
    calory decimal,
    PRIMARY KEY <span class="o">(</span>ID<span class="o">)</span>
<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>Now you have a database with a table great isn‚Äôt it ?</p>

<h2 id="connecting-our-database-with-cloud-sql-proxy-">Connecting our database with Cloud SQL Proxy üôÜ‚Äç</h2>

<p>There are 2 ways of connecting your database with GCP. The first one is by using a private IP which is the most straightforward way.</p>

<p>However Google is proposing an other way of connecting your database. This one is named CloudSQL Proxy and it‚Äôs made to be use with Kubernetes in mind. Therefore we‚Äôre going to take a look at how to implement the <a href="/gcp/sql_proxy.html">CloudSQL Proxy</a>.</p>

<h3 id="creating-a-new-user-">Creating a new user üíÅ‚Äç</h3>

<p>Firstly, we‚Äôre going to create a new user that‚Äôs going to be used by the CloudSQL Proxy. In order to create a user click on your <code class="highlighter-rouge">database</code> then click on the <code class="highlighter-rouge">users</code> tab. Create a new user with the following credentials</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>username: alison
password: bobba
</code></pre></div></div>

<p>Now let‚Äôs make a connection test in order to check that our user has been added.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud sql connect db <span class="nt">--user</span><span class="o">=</span>alison
</code></pre></div></div>

<p>Now let‚Äôs activate the <strong>cloud sql admin api</strong> by going into the <strong>API</strong> section of the GCP dashboard.</p>
<ul>
  <li>On the searchbar type: <code class="highlighter-rouge">cloud sql</code></li>
  <li>Click on the <strong>Cloud SQL Admin SQL</strong></li>
  <li>Click on the <strong>Enable</strong> button</li>
  <li>Create a service account by following this article <a href="https://cloud.google.com/sql/docs/mysql/sql-proxy#create-service-account">service account</a></li>
  <li>Get the instance connection name by running the command <code class="highlighter-rouge">gcloud sql instances describe db</code></li>
  <li>The name should be equal to the <code class="highlighter-rouge">connectionName</code> property within your yaml</li>
</ul>

<h3 id="create-the-credentials-Ô∏è">Create the credentials üóùÔ∏è</h3>

<p>We‚Äôre going to need 2 types of secrets:</p>

<ul>
  <li>
    <p>cloudsql-instance-credentials: Used by application to talk to the CloudSQL instance. It uses the credentials files generated when you create the service account.</p>
  </li>
  <li>
    <p>cloudsql-db-credentials: The new username &amp; password added to the database earlier.</p>
  </li>
</ul>

<p>Let‚Äôs create the secret for the <code class="highlighter-rouge">cloudsql-instance-credentials</code> by running the command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic cloudsql-instance-credentials <span class="nt">--from-file</span><span class="o">=</span>credentials.json<span class="o">=</span>&lt;path_to_generate_credentials_file.json&gt;

<span class="c"># If everything goes as expected the shell should print</span>
<span class="c"># secret "cloudsql-instance-credentials" created</span>
</code></pre></div></div>

<p>Let‚Äôs create the secret for the <code class="highlighter-rouge">cloudsql-db-credentials</code> by running this command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic cloudsql-db-credentials <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">username</span><span class="o">=</span>alison <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">password</span><span class="o">=</span>bobba

<span class="c"># If everything goes as expected the shell should print</span>
<span class="c"># secret "cloudsql-db-credentials" created</span>
</code></pre></div></div>

<h3 id="update-the-configuration-file-Ô∏è">Update the configuration file ‚úíÔ∏è</h3>

<p>Now that we have create our credentials let‚Äôs take a look at how the configuration is going to be. The <code class="highlighter-rouge">api.yml</code> deployment file already contain the configuration for configuration for cloudsql-proxy.</p>

<p>First we‚Äôre adding an other container to the pod definition of our <code class="highlighter-rouge">api.yml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spec</span><span class="pi">:</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="c1">#... the bobba-api container</span>
    <span class="c1"># Add the cloudsql-proxy below</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudsql-proxy</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/cloudsql-docker/gce-proxy:1.11</span>
        <span class="c1"># Command that's going to be executed when the pod will start</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/cloud_sql_proxy"</span><span class="pi">,</span>
                    <span class="s2">"</span><span class="s">-instances=kubernetes-demo-232217:us-central1:db=tcp:3306"</span><span class="pi">,</span>
                    <span class="s2">"</span><span class="s">-credential_file=/secrets/cloudsql/credentials.json"</span><span class="pi">]</span>
        <span class="na">securityContext</span><span class="pi">:</span>
            <span class="na">runAsUser</span><span class="pi">:</span> <span class="s">2</span>  <span class="c1"># non-root user</span>
            <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
        <span class="c1"># Reference the volume inside the container</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudsql-instance-credentials</span>
            <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/secrets/cloudsql</span>
            <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
    <span class="c1"># Link the volumes where our credentials are stored</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudsql-instance-credentials</span>
        <span class="s">secret</span><span class="pi">:</span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">cloudsql-instance-credentials</span>
</code></pre></div></div>

<p>Futhermore we‚Äôre updating the bobba-api container definition by providing <code class="highlighter-rouge">env</code> variables based on the <code class="highlighter-rouge">cloudsql-db-credentials</code> secret we create earlier. (This will override the original environment variables set to the Dockerfile.release)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">containers</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">bobba-api</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/kubernetes-demo-232217/sesame_api:v1</span>
  <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="c1"># Override the environment file that we'd define on the Dockerfile</span>
  <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_HOST</span>
        <span class="s">value</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_USER</span>
        <span class="s">valueFrom</span><span class="pi">:</span>
        <span class="na">secretKeyRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">cloudsql-db-credentials</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">username</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_PASSWORD</span>
        <span class="s">valueFrom</span><span class="pi">:</span>
        <span class="na">secretKeyRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">cloudsql-db-credentials</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">password</span>    
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">8000</span>
  <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sh</span>
    <span class="pi">-</span> <span class="s">start.sh</span>
</code></pre></div></div>

<h4 id="now-lets-deploy-our-api">Now let‚Äôs deploy our <a href="/gcp/deployment_api.html">API</a></h4>

        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 kubernetes-docker-lab. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
