<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CronJob - kubernetes-docker-lab</title>
<meta name="description" content="Learning how to deploy a web app from Docker to Kubernetes to GCloud">



<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="kubernetes-docker-lab">
<meta property="og:title" content="CronJob">
<meta property="og:url" content="http://localhost:4000/k8s/deployment/cron.html">













<link rel="canonical" href="http://localhost:4000/k8s/deployment/cron.html">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="kubernetes-docker-lab Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">kubernetes-docker-lab</a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Docker</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/docker/intro" class="">Introduction to docker</a></li>
          
            
            

            
            

            <li><a href="/docker/example" class="">Example of deployment with Docker</a></li>
          
            
            

            
            

            <li><a href="/k8s/swarm" class="">Docker swarm</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Kubernetes knowledges</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/k8s/architecture" class="">Architecture</a></li>
          
            
            

            
            

            <li><a href="/k8s/deployment" class="">Deployment</a></li>
          
            
            

            
            

            <li><a href="/k8s/services" class="">Service</a></li>
          
            
            

            
            

            <li><a href="/k8s/storage" class="">Volumes</a></li>
          
            
            

            
            

            <li><a href="/k8s/cron" class="">Cron task</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Deploying an app to minikube</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/k8s/minikube" class="">Minikube</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CronJob">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CronJob
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>In this section we will take a look at how to implement a CronJob in Kubernetes by using Minikube.</p>

<h2 id="configuration">Configuration</h2>

<p>In order to do this deployment youâ€™ll need to have minikube installed as well as having Docker.</p>

<h2 id="images-">Images ðŸ’¿</h2>

<p>For these deployment examples weâ€™ll use an image which is located in the <strong>build/cron</strong> folder. I suggested you to take a look at it. Itâ€™s based on the golang image.</p>

<h2 id="steps">Steps</h2>

<h3 id="creating-the-docker-image">Creating the docker image</h3>

<p>First, we will need to start minikube.</p>

<p>Start minikube with the following command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube start
</code></pre></div></div>

<p>Now if you do</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker ps
</code></pre></div></div>

<p>You should see a list of <strong>docker images</strong>. Great !
If thatâ€™s the case we can then proceed to build a docker image. We will use this image as the main image for our CronJob. Run this command within the same terminal or window terminal. We donâ€™t want to loose the dockerâ€™s environment variable set to minikube :)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build <span class="nt">-t</span> sesame_minikube <span class="nt">-f</span> build/cron/Dockerfile &lt;Absolute path to the project&gt;/kubernetes-docker-lab
</code></pre></div></div>

<h4 id="image-explanation">Image explanation</h4>

<p>The docker image is based on the golang alpine docker. It <strong>mount</strong> the folder <strong>cron</strong> into the <strong>task</strong> folder within the pod.</p>

<p>The <em>-f</em> option is used to in order to provide the context of execution to the docker. We want to run the build from the root folder of the project in order to mount the <strong>cron</strong> folder properly</p>

<p>Now that weâ€™d build our docker image we will configure our CronJob file.</p>

<h2 id="configuration-of-a-cronjob">Configuration of a CronJob</h2>

<p>Kubernetes make it easy to configure a cronjob. Below is a sample of what look like a CronJob</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CronJob &lt;Kind of controller&gt;</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">&lt;name of the service&gt;</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;timeout&gt;"</span>
  <span class="na">jobTemplate</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">template</span><span class="pi">:</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">&lt;name of the container&gt;</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">&lt;name of the image&gt;</span>
            <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Never --&gt; We use this value as we want to use a local image</span>
            <span class="na">args</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">a list of arguments that could be use during the startup of the pod</span>
          <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">&lt;See the restart policy section&gt;</span>

</code></pre></div></div>

<p>Pretty sample right ? Below is the description of each field</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Kind</td>
      <td>Represent the type of controller to uses</td>
    </tr>
    <tr>
      <td>name</td>
      <td>The name of the CronJob</td>
    </tr>
    <tr>
      <td>schedulde</td>
      <td>The timeout before the cronjob trigger itself. This respect the default definition of triggering a cronjob</td>
    </tr>
    <tr>
      <td>containers.name</td>
      <td>The name of the containers</td>
    </tr>
    <tr>
      <td>containers.image</td>
      <td>The name of the image use by the container. In our case it represent a local docker images</td>
    </tr>
    <tr>
      <td>containers.imagePullPolicy</td>
      <td>Strategy to use when dealing with update, creating an image</td>
    </tr>
    <tr>
      <td>containers.args</td>
      <td>A list of arguments that can be triggered during the executon of the pod</td>
    </tr>
    <tr>
      <td>restartPolicy</td>
      <td>The kind of restarting strategy when something wrong happened to the pod</td>
    </tr>
  </tbody>
</table>

<p>Below is an example of how the configuration of a cronjob looks.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CronJob</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">bruteforce</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*/15</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*"</span>
  <span class="na">jobTemplate</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">template</span><span class="pi">:</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">bruteforce</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">sesame_minikube</span>
            <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Never</span>
            <span class="na">args</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">sh</span>
            <span class="pi">-</span> <span class="s">install.sh</span>
            <span class="pi">-</span> <span class="s">go</span>
            <span class="pi">-</span> <span class="s">run</span>
            <span class="pi">-</span> <span class="s">bruteforce/bruteforce.go</span>
          <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>

</code></pre></div></div>

<h2 id="running-the-cron">Running the CRON</h2>

<p>First weâ€™re going to create the service within our cluster by running this command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> k8s/job/cronjob-temporary.yaml
</code></pre></div></div>

<p>Now letâ€™s check if the cronjob services has been created by running this command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get cronjob &lt;cronjob_name&gt;
</code></pre></div></div>

<p>Once you see the cronjob within the list. Your cronjob task should be able to be trigger based on the schedulde you defined. Or you could either check if a pod has been created by the CronJob with the following command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get <span class="nb">jobs</span> <span class="nt">--watch</span>
</code></pre></div></div>

<p>Once you see a new job appaear on the list this mean that a <strong>new pod</strong> has been created. You could also check the status of the pod by running this command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<h2 id="debugging-the-cronjob">Debugging the CronJob</h2>

<p>Sometimes it can happened that you missly configured the cronjob or that something went wrong.</p>

<p>I suggested you to firstly get the <strong>events</strong> of the pod. It will tell you if there are anything wrong regarding the configuration of the CronJob</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pod &lt;name of failed pod&gt;
</code></pre></div></div>

<p>Secondly if you didnâ€™t see anything wrong with the pod I suggested you to take a look at the logs of the pod.</p>

<p>Below is the command to check the log for an active pod</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs <span class="nt">-p</span> &lt;pods_name&gt;
</code></pre></div></div>

<p>If the pod is in terminated status or not running you could use this command</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs &lt;pod_name&gt;
</code></pre></div></div>

<p>ðŸŽ‰ Now you know how to deploy a CronJob with minikube ! ðŸŽ‰</p>

        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 kubernetes-docker-lab. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
